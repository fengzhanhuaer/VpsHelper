{% extends "base.html" %}

{% block title %}æ–°å»ºä»»åŠ¡ - è‡ªåŠ¨å‘é€{% endblock %}

{% block content %}
<h1>â• æ–°å»ºè‡ªåŠ¨å‘é€ä»»åŠ¡</h1>

{% if error %}
<div class="alert alert-error">
    {{ error }}
</div>
{% endif %}

<form method="POST" action="{{ url_for('tg_new_task', token=token) if token else url_for('tg_new_task') }}">
    {% if token %}
    <input type="hidden" name="token" value="{{ token }}">
    {% endif %}

    <div class="form-group">
        <label for="account_id">é€‰æ‹©è´¦å·</label>
        <select id="account_id" name="account_id" required onchange="this.form.submit()">
            <option value="">è¯·é€‰æ‹©è´¦å·</option>
            {% for account in accounts %}
            <option value="{{ account.id }}" {{ 'selected' if account.id|string == selected_account_id else '' }}>
                {{ account.account_name }}
            </option>
            {% endfor %}
        </select>
    </div>

    {% if selected_account_id %}
    <div class="form-group">
        <label for="dialog_id">é€‰æ‹©ä¼šè¯</label>
        <select id="dialog_id" name="dialog_id" required>
            <option value="">è¯·é€‰æ‹©ä¼šè¯</option>
            {% for dialog in dialogs %}
            <option value="{{ dialog.dialog_id }}">
                {{ dialog.title or dialog.username or dialog.dialog_id }}
            </option>
            {% endfor %}
        </select>
        <div style="margin-top: 10px;">
            <button type="submit" formaction="{{ url_for('tg_refresh_dialogs', token=token) if token else url_for('tg_refresh_dialogs') }}" 
                    class="btn btn-secondary" style="padding: 8px 20px; font-size: 0.9em;">
                ğŸ”„ åˆ·æ–°ä¼šè¯åˆ—è¡¨
            </button>
        </div>
    </div>

    <div class="form-group">
        <label for="message">å‘é€å†…å®¹</label>
        <textarea id="message" name="message" rows="6" required 
                  placeholder="è¯·è¾“å…¥è¦å‘é€çš„æ¶ˆæ¯å†…å®¹"></textarea>
    </div>

    <div class="form-group">
        <label for="time_of_day">æ¯å¤©å‘é€æ—¶é—´</label>
        <input type="text" id="time_of_day" name="time_of_day" required 
               placeholder="HH:MM æ ¼å¼ï¼Œä¾‹å¦‚: 09:30">
        <small style="color: #666; display: block; margin-top: 5px;">
            24å°æ—¶åˆ¶ï¼Œä¾‹å¦‚ 09:30 è¡¨ç¤ºæ¯å¤©æ—©ä¸Š9ç‚¹30åˆ†
        </small>
    </div>

    <div class="form-group">
        <label for="jitter_seconds">éšæœºå»¶è¿Ÿï¼ˆç§’ï¼‰</label>
        <input type="text" id="jitter_seconds" name="jitter_seconds" value="0" 
               placeholder="0-3600">
        <small style="color: #666; display: block; margin-top: 5px;">
            åœ¨è®¾å®šæ—¶é—´åŸºç¡€ä¸Šéšæœºå»¶è¿Ÿ0åˆ°æŒ‡å®šç§’æ•°ï¼Œé¿å…è¢«æ£€æµ‹
        </small>
    </div>

    <div class="form-group">
        <label>
            <input type="checkbox" name="enabled" checked>
            å¯ç”¨ä»»åŠ¡
        </label>
    </div>

    <div class="form-group" style="text-align: center;">
        <button type="submit" class="btn">ğŸ’¾ ä¿å­˜ä»»åŠ¡</button>
    </div>
    {% else %}
    <div style="text-align: center; padding: 40px; color: #999;">
        <p>è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè´¦å·</p>
    </div>
    {% endif %}
</form>

<div class="back-button">
    <a href="{{ url_for('tg_auto_send', token=token) if token else url_for('tg_auto_send') }}" class="btn btn-secondary">â¬…ï¸ è¿”å›</a>
</div>
{% endblock %}
