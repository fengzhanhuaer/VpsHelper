{% extends "base.html" %}

{% block title %}ç®¡ç†ä»»åŠ¡ - è‡ªåŠ¨å‘é€{% endblock %}

{% block content %}
<h1>ğŸ“‹ ç®¡ç†è‡ªåŠ¨å‘é€ä»»åŠ¡</h1>

{% if error %}
<div class="alert alert-error">
    {{ error }}
</div>
{% endif %}

{% if message %}
<div class="alert alert-success">
    {{ message }}
</div>
{% endif %}

<form method="GET" action="{{ url_for('tg_auto_send_manage', token=token) if token else url_for('tg_auto_send_manage') }}">
    {% if token %}
    <input type="hidden" name="token" value="{{ token }}">
    {% endif %}

    <div class="form-group">
        <label for="account_id">é€‰æ‹©è´¦å·</label>
        <select id="account_id" name="account_id" onchange="this.form.submit()">
            <option value="">è¯·é€‰æ‹©è´¦å·</option>
            {% for account in accounts %}
            <option value="{{ account.id }}" {{ 'selected' if account.id|string == selected_account_id else '' }}>
                {{ account.account_name }}
            </option>
            {% endfor %}
        </select>
    </div>
</form>

{% if selected_account_id and tasks %}
<div style="overflow-x: auto; margin: 30px 0;">
    <table>
        <thead>
            <tr>
                <th>ä¼šè¯</th>
                <th>æ¶ˆæ¯å†…å®¹</th>
                <th>å‘é€æ—¶é—´</th>
                <th>éšæœºå»¶è¿Ÿ</th>
                <th>çŠ¶æ€</th>
                <th>ä¸‹æ¬¡è¿è¡Œ</th>
                <th>æœ€åç»“æœ</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for task in tasks %}
            <tr>
                <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">
                    {{ task.dialog_name }}
                </td>
                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" 
                    title="{{ task.message }}">
                    {{ task.message[:50] }}{{ '...' if task.message|length > 50 else '' }}
                </td>
                <td>{{ task.time_of_day }}</td>
                <td>{{ task.jitter_seconds }}ç§’</td>
                <td>
                    <span style="color: {{ 'green' if task.enabled else 'red' }}; font-weight: 600;">
                        {{ 'âœ… å¯ç”¨' if task.enabled else 'â¸ï¸ æš‚åœ' }}
                    </span>
                </td>
                <td style="font-size: 0.9em;">{{ task.next_run_at or '-' }}</td>
                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; font-size: 0.85em;" 
                    title="{{ task.last_result or '-' }}">
                    {{ (task.last_result[:40] + '...') if task.last_result and task.last_result|length > 40 else (task.last_result or '-') }}
                </td>
                <td style="white-space: nowrap;">
                    <form method="POST" style="display: inline;" 
                          action="{{ url_for('tg_toggle_task', task_id=task.id, token=token) if token else url_for('tg_toggle_task', task_id=task.id) }}">
                        {% if token %}
                        <input type="hidden" name="token" value="{{ token }}">
                        {% endif %}
                        <input type="hidden" name="account_id" value="{{ selected_account_id }}">
                        <button type="submit" style="background: none; border: none; color: #667eea; cursor: pointer; text-decoration: underline;">
                            {{ 'â¸ï¸' if task.enabled else 'â–¶ï¸' }}
                        </button>
                    </form>
                    
                    <form method="POST" style="display: inline;" 
                          action="{{ url_for('tg_run_task', task_id=task.id, token=token) if token else url_for('tg_run_task', task_id=task.id) }}">
                        {% if token %}
                        <input type="hidden" name="token" value="{{ token }}">
                        {% endif %}
                        <input type="hidden" name="account_id" value="{{ selected_account_id }}">
                        <button type="submit" style="background: none; border: none; color: #28a745; cursor: pointer; text-decoration: underline;">
                            â–¶ï¸è¿è¡Œ
                        </button>
                    </form>
                    
                    <a href="{{ url_for('tg_edit_task', task_id=task.id, account_id=selected_account_id, token=token) if token else url_for('tg_edit_task', task_id=task.id, account_id=selected_account_id) }}" 
                       style="color: #ffc107; text-decoration: none; margin: 0 5px;">âœï¸</a>
                    
                    <form method="POST" style="display: inline;" 
                          action="{{ url_for('tg_delete_task', task_id=task.id, token=token) if token else url_for('tg_delete_task', task_id=task.id) }}"
                          onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')">
                        {% if token %}
                        <input type="hidden" name="token" value="{{ token }}">
                        {% endif %}
                        <input type="hidden" name="account_id" value="{{ selected_account_id }}">
                        <button type="submit" style="background: none; border: none; color: #dc3545; cursor: pointer; text-decoration: underline;">
                            ğŸ—‘ï¸
                        </button>
                    </form>
                </td>
            </tr>
            {% if task.last_reply %}
            <tr style="background: #f0f8ff;">
                <td colspan="8" style="padding: 10px; font-size: 0.9em; color: #666;">
                    <strong>ğŸ’¬ æœ€åå›å¤ï¼š</strong> {{ task.last_reply }}
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>
{% elif selected_account_id %}
<div style="text-align: center; padding: 40px; color: #999;">
    <p style="font-size: 1.2em;">æš‚æ— ä»»åŠ¡</p>
    <p>ç‚¹å‡»ä¸‹æ–¹"æ–°å»ºä»»åŠ¡"æŒ‰é’®æ¥åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªè‡ªåŠ¨å‘é€ä»»åŠ¡</p>
</div>
{% endif %}

<div style="margin-top: 30px; text-align: center;">
    <a href="{{ url_for('tg_new_task', account_id=selected_account_id, token=token) if token else url_for('tg_new_task', account_id=selected_account_id) }}" class="btn">
        â• æ–°å»ºä»»åŠ¡
    </a>
</div>

<div class="back-button">
    <a href="{{ url_for('tg_auto_send', token=token) if token else url_for('tg_auto_send') }}" class="btn btn-secondary">â¬…ï¸ è¿”å›</a>
</div>
{% endblock %}
